---
title: 'Week 4: Points and Polygons'
author: "Carole Voulgaris"
date: "9/17/2020"
output: 
  html_document:
    theme: cosmo
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, message=FALSE}
library(sf)
library(tidyverse)
library(ggthemes)
library(ggspatial)
library(units)
```

## Load the data

First, I'll read in all four datasets from the Boston Open Data portal (refer to the video tutorial for how I got the urls to read from).

As I read in each dataset, I'm also going to transform the data to the Massachusetts State Plane coordinate system.

```{r}
MA_state_plane <- "+proj=lcc +lat_1=41.71666666666667 +lat_2=42.68333333333333 +lat_0=41 +lon_0=-71.5 +x_0=200000 +y_0=750000 +ellps=GRS80 +units=m +no_defs"

nhoods <- st_read("http://bostonopendata-boston.opendata.arcgis.com/datasets/3525b0ee6e6b427f9aab5d0a1d0a1a28_0.kml?outSR={%22latestWkid%22:2249,%22wkid%22:102686}", quiet = TRUE) %>%
  st_transform(MA_state_plane)
  

water <- st_read("http://bostonopendata-boston.opendata.arcgis.com/datasets/2b3c0fa13b1c468eb702a3645fcc6bcb_5.kml", quiet = TRUE) %>%
  st_transform(MA_state_plane)

parking <- st_read("http://bostonopendata-boston.opendata.arcgis.com/datasets/962da9bb739f440ba33e746661921244_9.kml?outSR={%22latestWkid%22:2249,%22wkid%22:102686}", quiet = TRUE) %>%
  st_transform(MA_state_plane)

trees <- st_read("http://bostonopendata-boston.opendata.arcgis.com/datasets/ce863d38db284efe83555caf8a832e2a_1.kml", quiet = TRUE) %>%
  st_transform(MA_state_plane)

```

I'll draw a quick map now to see how the data look.

```{r}
ggplot(water) +
  geom_sf(fill = "lightblue", color = NA) +
  geom_sf(data = trees, color = "darkgreen", size = 0.01) +
  geom_sf(data = parking, size = 0.01) +
  geom_sf(data= nhoods, fill = NA, color = "gray") +
  theme_map()
```

## Creating a buffer

The Massachusetts State Plane coordinate system I'm using is in units of meters (notice that the proj4 string says `+units=m` towards the end).

How many of the trees in Boston are within 30 meters of a parking meter?

To figure this out, I'll create a new polygon layer to represent a 30-meter buffer around the parking meters. Then I'll plot a quick map to see how it looks.

```{r}
parking_buffer <- st_buffer(parking, dist = 30) %>%
  st_union()

ggplot(parking_buffer) +
  geom_sf() +
  theme_map()
```

## Which points are within a polygon?

Now I can create a dataframe of just the trees that are located within the parking meter buffer.

```{r}
trees_parking <- trees[parking_buffer,]
  
ggplot(parking_buffer) +
  geom_sf() +
  geom_sf(data = trees_parking, 
          color = "darkgreen", 
          size = 0.01) +
  theme_map()
```

Now I'll join my two trees dataframes. Any trees that are in the full dataset, but in the set of trees that are by parking meters will have an NA value for the variables Name.y and Description.y, so I can use that to create a binary variable that indicates whether the tres is by a parking meter.

```{r}
trees <- trees %>%
  st_join(trees_parking) %>%
  mutate(by_parking = !is.na(Name.y))
```

Now we can calculate how many trees are within 30 meters of a parking meter:

```{r}
sum(trees$by_parking)
```

And what percent of all tree this represents.

```{r}
sum(trees$by_parking) / length(trees$by_parking)
```

About 4 percent of all trees in Boston are within 30 meters of a parking meter.

Let's show this on a pretty map!

```{r}
ggplot(water) +
  geom_sf(fill = "lightblue", color = NA) +
  geom_sf(data = trees, size = 0.01,
          aes(color = by_parking)) +
  scale_color_manual(values = c("lightgreen", "darkgreen"),
          name = "Boston Trees\nby distance to a parking meter", 
          labels = c("No parking meter within 30 m",
                     "Parking meter within 30 m")) +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr",
                         style = north_arrow_minimal()) +
  annotate(geom = "text", x = st_bbox(trees)$xmin, 
           y = st_bbox(trees)$ymax, 
           label = paste("Of the ", prettyNum(length(trees$Name), 
                                             big.mark = ","),
                         " trees in Boston\n", 
                         prettyNum(sum(trees$by_parking),
                                   big.mark = ","),
                         " (", prettyNum(100*sum(trees$by_parking) /
                                          length(trees$Name),
                                        digits = 0),
                         "%) are within 30\nmeters of a parking meter.",
                         sep = ""),
           hjust = 0, vjust = 0, size = 3) +
  theme_map() +
  theme(panel.background = element_rect(fill = "cornsilk1"),
        legend.background = element_rect(fill = alpha("white", 0.5), 
                                         color = "gray"))
```


## How many points are in a polygon?

What if I wanted to know how many trees are in each Boston neighborhood?

```{r}
nhoods <- nhoods %>%
  mutate(num_trees = lengths(st_covers(nhoods, trees)))

ggplot(nhoods) +
  geom_sf(color = NA, 
          aes(fill = num_trees)) +
  scale_fill_viridis_c(name = "Boston neighborhoods\nby number of trees",
                       breaks = breaks <- seq(0, 30000, by = 5000),
                       labels = paste(prettyNum(breaks, big.mark = ","),
                                      "trees")) +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr",
                         style = north_arrow_minimal()) +
theme_map() +
  theme(legend.background = element_rect(fill = alpha("white", 0.5), 
                                         color = "gray"))
```


## Calculating areas and densities

Maybe I'm more interested in the density of trees (the number of trees per square km). To calculate that, I'd need to find the area of each neighborhood.

```{r}
nhoods <- nhoods %>%
  mutate(area = set_units(st_area(nhoods), km^2)) %>%
  mutate(tree_dens = as.numeric(num_trees / area))

ggplot(nhoods) +
  geom_sf(color = NA, 
          aes(fill = tree_dens)) +
    scale_fill_viridis_c(name = 
                           "Boston neighborhoods\nby tree density",
                       breaks = breaks <- seq(0, 4000, by = 500),
                       labels = paste(prettyNum(breaks, big.mark = ","),
                                      "trees per square km")) +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr",
                         style = north_arrow_minimal()) +
theme_map() +
  theme(legend.position = "right",
    legend.background = element_rect(fill = alpha("white", 0.5), 
                                         color = "gray"))
```